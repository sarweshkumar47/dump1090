#!/bin/bash

h_tmp_dir="/tmp"
h_prog_name="dump1090_demo"
h_pid=$$
h_time_range="20 minute"
h_database="dump1090"
h_ii_system="/opt/Actian/IngresT2"

h_sql_script=$h_tmp_dir"/"$h_prog_name".sql".$h_pid
h_sql_output=$h_tmp_dir"/"$h_prog_name".sql.out".$h_pid


while true 
do

echo "set lockmode session where readlock=nolock; 
      \p\g
      commit;
      \p\g

      select max(date_msg_gen) as date_msg_gen from dump1090_id
      \p\g

     " > $h_sql_script

sql -s $h_database < $h_sql_script > $h_sql_output

h_start_date=`cat $h_sql_output | grep -v "date_msg_g" | grep "^|" | sed -e "s/|//g"`

echo "set lockmode session where readlock=nolock; 
      \p\g
      commit;
      \p\g

      select
       time(date_trunc('minute',max(time_msg_gen)))             as end_time,
       time(date_trunc('minute',max(time_msg_gen))-'$h_time_range')  as start_time
     from
       dump1090_id
     where
       date_msg_gen = '$h_start_date'
     \p\g

     " > $h_sql_script

sql -s $h_database < $h_sql_script > $h_sql_output


h_end_time=`cat $h_sql_output | grep -v "end_time" | grep "^|" | awk -F"|" '{print $2}'`

h_start_time=`cat $h_sql_output | grep -v "end_time" | grep "^|" | awk -F"|" '{print $3}'`

echo "====================================="
date
echo $h_start_date
echo $h_end_time
echo $h_start_time


./dump1090_build_map --ii_system $h_ii_system --database $h_database --test 1 --start_date $h_start_date --end_date $h_start_date --start_time $h_start_time --end_time $h_end_time


done
